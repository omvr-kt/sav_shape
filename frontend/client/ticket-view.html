<!DOCTYPE html>
<html lang="fr" class="theme-shape">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket #TCK-2024-001 - Shape SAV</title>
    <!-- Theme Shape Design System -->
    <link rel="stylesheet" href="/styles/theme-shape.css">
    <link rel="stylesheet" href="/src/components/ui/index.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/sidebar.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <link rel="stylesheet" href="/assets/css/client.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <div class="sidebar__logo">S</div>
                <div class="sidebar__logo-text">Shape SAV</div>
            </div>

            <nav class="sidebar__nav">
                <div class="sidebar__nav-section">
                    <a href="/client/tickets.html" class="sidebar__nav-item sidebar__nav-item--active">
                        <span class="sidebar__nav-text">Mes Tickets</span>
                        <span class="sidebar__nav-badge" id="ticketCount">0</span>
                    </a>
                    <a href="/client/invoices.html" class="sidebar__nav-item">
                        <span class="sidebar__nav-text">Mes Factures</span>
                    </a>
                    <a href="/client/profile.html" class="sidebar__nav-item">
                        <span class="sidebar__nav-text">Mon Profil</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar__footer">
                <div class="sidebar__user" id="sidebarUser">
                    <div class="sidebar__user-avatar" id="sidebarUserAvatar">--</div>
                    <div class="sidebar__user-info">
                        <div class="sidebar__user-name" id="sidebarUserName">Chargement...</div>
                        <div class="sidebar__user-role">Client</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <header class="main-header" style="padding: var(--space-2) var(--space-3); margin-bottom: var(--space-2);">
                <div class="main-header__left">
                    <div style="padding-left: var(--space-2);">
                        <h1 class="main-title" style="margin-bottom: var(--space-1);">Ticket #TCK-2024-001</h1>
                        <p class="main-subtitle" style="margin: 0;">Problème de connexion sur l'espace admin</p>
                    </div>
                </div>
                <div class="main-header__right">
                    <button class="btn btn--ghost btn--sm">← Retour</button>
                    <button class="btn btn--ghost btn--sm">Actions ▼</button>
                    <button id="logoutBtn" class="btn btn--ghost btn--sm">Déconnexion</button>
                </div>
            </header>
            
            <main class="page-content">
                
                <!-- Informations principales du ticket -->
                <div class="card" style="margin-bottom: var(--space-6);">
                    <div class="card-header">
                        <div>
                            <h2 style="font-family: var(--font-heading); font-size: 24px; margin: 0; color: var(--color-primary);">
                                Problème de connexion sur l'espace admin
                            </h2>
                            <div style="display: flex; gap: var(--space-3); align-items: center; margin-top: var(--space-2);">
                                <span class="badge status-en-cours">En cours</span>
                                <span class="badge" style="background: var(--color-error); color: var(--color-surface);">Urgent</span>
                                <span style="color: var(--color-muted); font-size: 14px;">
                                    Project: Site Web E-commerce
                                </span>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning" style="margin: 0; max-width: 300px;">
                            <div style="font-weight: 600;">SLA dans 4h</div>
                            <div style="font-size: 12px; margin-top: 4px;">
                                Temps de réponse contractuel bientôt dépassé
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Métadonnées du ticket -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-5); margin-bottom: var(--space-5); padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md);">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em;">Créé le</div>
                                <div style="font-size: 16px; color: var(--color-text); margin-top: 4px;">15 janvier 2024, 14:30</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em;">Dernière mise à jour</div>
                                <div style="font-size: 16px; color: var(--color-text); margin-top: 4px;">Il y a 2 heures</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em;">Assigné à</div>
                                <div style="font-size: 16px; color: var(--color-text); margin-top: 4px;">Thomas Martin</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em;">Temps de résolution</div>
                                <div style="font-size: 16px; color: var(--color-text); margin-top: 4px;">6h restantes</div>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div style="margin-bottom: var(--space-5);">
                            <h4 style="font-family: var(--font-heading); font-size: 18px; color: var(--color-primary); margin-bottom: var(--space-3);">
                                Description du problème
                            </h4>
                            <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-4); line-height: 1.6;">
                                <p>Bonjour,</p>
                                <p>Depuis hier soir (14 janvier vers 23h), il m'est impossible de me connecter à l'interface d'administration de notre site e-commerce.</p>
                                <p>Quand je saisis mes identifiants habituels, j'obtiens systématiquement le message d'erreur : <code style="background: var(--color-bg); padding: 2px 4px; border-radius: 3px; font-family: monospace;">"Identifiants incorrects"</code></p>
                                <p><strong>Informations techniques :</strong></p>
                                <ul>
                                    <li>URL concernée : <a href="https://admin.monsite.com" style="color: var(--color-primary);">https://admin.monsite.com</a></li>
                                    <li>Navigateur testé : Chrome 120.0.6099.109 et Firefox 121.0</li>
                                    <li>J'ai essayé de vider le cache et les cookies</li>
                                    <li>Le problème persiste en navigation privée</li>
                                </ul>
                                <p>Ce problème bloque complètement la gestion de notre boutique en ligne. Nous avons besoin d'une résolution rapide.</p>
                                <p>Merci de votre aide,<br>Marie Dubois</p>
                            </div>
                        </div>
                        
                        <!-- Pièces jointes -->
                        <div style="margin-bottom: var(--space-5);">
                            <h4 style="font-family: var(--font-heading); font-size: 18px; color: var(--color-primary); margin-bottom: var(--space-3);">
                                Pièces jointes (2)
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                    <div style="font-size: 24px;">Image</div>
                                    <div style="flex: 1;">
                                        <a href="#" style="color: var(--color-primary); font-weight: 500; text-decoration: none;">screenshot-erreur-connexion.png</a>
                                        <div style="font-size: 14px; color: var(--color-muted);">Image • 342 Ko</div>
                                    </div>
                                    <button class="btn btn-outline" style="padding: 6px 12px;">
                                        Télécharger
                                    </button>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                    <div style="font-size: 24px;">File</div>
                                    <div style="flex: 1;">
                                        <a href="#" style="color: var(--color-primary); font-weight: 500; text-decoration: none;">logs-navigateur.txt</a>
                                        <div style="font-size: 14px; color: var(--color-muted);">Texte • 12 Ko</div>
                                    </div>
                                    <button class="btn btn-outline" style="padding: 6px 12px;">
                                        Télécharger
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conversation avec l'équipe -->
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 24px;">
                    <div style="padding: 20px; border-bottom: 1px solid #f3f4f6;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #1f2937; margin: 0;">Conversation avec l'équipe (<span id="commentsCount">0</span>)</h3>
                        <div style="font-size: 14px; color: #6b7280; margin-top: 4px;" id="lastCommentTime">
                            Tous les échanges entre vous et notre équipe support
                        </div>
                    </div>
                    <div id="commentsList" style="max-height: 500px; overflow-y: auto; padding: 16px;">
                        <div class="loading" style="padding: 40px; text-align: center; color: #9ca3af;">
                            Chargement de la conversation...
                        </div>
                    </div>
                </div>
                    
                <!-- Zone d'ajout de commentaire -->
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                    <h3 style="font-size: 16px; font-weight: 600; color: #1f2937; margin: 0 0 16px 0;">Ajouter un commentaire</h3>
                        
                    <form id="commentForm" style="display: flex; flex-direction: column; gap: 16px;">
                        <textarea 
                            id="commentContent"
                            placeholder="Écrivez votre commentaire ou question ici..."
                            rows="4"
                            style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; line-height: 1.5; resize: vertical; font-family: inherit;"
                            required
                        ></textarea>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <label for="fileInput" style="display: flex; align-items: center; gap: 6px; color: #6b7280; cursor: pointer; font-size: 14px;">
                                    📎 Joindre un fichier
                                </label>
                                <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.txt" style="display: none;">
                            </div>
                            <button type="submit" id="submitBtn" style="background: #0e2433; color: white; border: none; border-radius: 6px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                Envoyer le commentaire
                            </button>
                        </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Overlay mobile -->
    
    <script src="/assets/js/api.js?v=1757350256"></script>
    <script>

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('token');
            window.location.href = '/connexion.html';
        });

        // Load user info
        function loadUserInfo() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/connexion.html';
                return;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('sidebarUserName').textContent = payload.email || 'Utilisateur';
                document.getElementById('sidebarUserAvatar').textContent = (payload.email || 'U').charAt(0).toUpperCase();
            } catch (e) {
                console.error('Token invalide', e);
                window.location.href = '/connexion.html';
            }
        }

        loadUserInfo();
        loadTicketComments();
        
        // Load ticket comments dynamically
        async function loadTicketComments() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const ticketId = urlParams.get('id') || 1; // Default to 1 for demo
                
                const response = await api.getTicketComments(ticketId);
                
                if (response.success) {
                    renderComments(response.data.comments);
                    updateCommentsInfo(response.data.comments);
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des commentaires:', error);
                document.getElementById('commentsList').innerHTML = `
                    <div style="padding: var(--space-5); text-align: center; color: var(--color-error);">
                        Erreur lors du chargement des commentaires
                    </div>
                `;
            }
        }
        
        function updateCommentsInfo(comments) {
            const commentsCount = document.getElementById('commentsCount');
            const lastCommentTime = document.getElementById('lastCommentTime');
            
            commentsCount.textContent = comments.length;
            
            if (comments.length > 0) {
                const lastComment = comments[comments.length - 1];
                lastCommentTime.textContent = `Dernière réponse ${formatTimeAgo(lastComment.created_at)}`;
            } else {
                lastCommentTime.textContent = 'Aucun commentaire';
            }
        }
        
        function renderComments(comments) {
            const commentsList = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                commentsList.innerHTML = `
                    <div style="padding: var(--space-5); text-align: center; color: var(--color-muted);">
                        <div style="font-size: 48px; margin-bottom: var(--space-3); opacity: 0.3;">💬</div>
                        <p>Aucun commentaire pour le moment</p>
                        <p style="font-size: 14px;">Soyez le premier à ajouter un commentaire !</p>
                    </div>
                `;
                return;
            }
            
            commentsList.innerHTML = comments.map((comment, index) => {
                // Determine if this is from client or support team
                const isFromClient = comment.role === 'client';
                
                // Get author initials
                const initials = comment.first_name 
                    ? comment.first_name.charAt(0).toUpperCase()
                    : (isFromClient ? 'V' : 'S'); // V=Vous, S=Support
                
                return `
                    <div style="display: flex; ${isFromClient ? 'justify-content: flex-end' : 'justify-content: flex-start'}; margin-bottom: 16px;">
                        <div style="max-width: 70%; ${isFromClient ? 'margin-left: auto' : 'margin-right: auto'};">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px; ${isFromClient ? 'flex-direction: row-reverse;' : ''}">
                                <div style="width: 28px; height: 28px; border-radius: 50%; background: ${isFromClient ? '#0e2433' : '#e3f2fd'}; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: ${isFromClient ? 'white' : '#1565c0'}; font-weight: 600; font-size: 11px;">
                                        ${initials}
                                    </span>
                                </div>
                                <span style="font-size: 12px; color: #6b7280; font-weight: 500;">
                                    ${isFromClient ? 'Vous' : (comment.first_name || 'Équipe support')} ${!isFromClient && comment.last_name ? comment.last_name : ''}
                                </span>
                                <span style="font-size: 11px; color: #9ca3af;">
                                    ${formatTimeAgo(comment.created_at)}
                                </span>
                            </div>
                            <div style="background: ${isFromClient ? '#0e2433' : '#ffffff'}; color: ${isFromClient ? 'white' : '#374151'}; padding: 12px 16px; border-radius: 12px; ${isFromClient ? 'border-bottom-right-radius: 4px;' : 'border-bottom-left-radius: 4px;'} box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: ${isFromClient ? 'none' : '1px solid #e5e7eb'};">
                                <div style="line-height: 1.4; font-size: 14px;">
                                    ${comment.content.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getRoleLabel(role) {
            const roleLabels = {
                'client': 'Client',
                'admin': 'Support technique',
                'team': 'Équipe support'
            };
            return roleLabels[role] || 'Utilisateur';
        }
        
        function renderAttachments(attachments) {
            return `
                <div style="margin-top: var(--space-3);">
                    <div style="font-size: 12px; color: var(--color-muted); margin-bottom: var(--space-2); font-weight: 500;">
                        📎 Pièces jointes (${attachments.length})
                    </div>
                    <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                        ${attachments.map(attachment => `
                            <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2); background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-sm);">
                                <div style="font-size: 16px;">${getFileIcon(attachment.mime_type)}</div>
                                <div style="flex: 1;">
                                    <a href="/api/attachments/${attachment.id}/download" target="_blank" style="color: var(--color-primary); font-weight: 500; text-decoration: none; font-size: 14px;">
                                        ${attachment.original_name}
                                    </a>
                                    <div style="font-size: 12px; color: var(--color-muted);">
                                        ${formatFileSize(attachment.file_size)}
                                    </div>
                                </div>
                                <a href="/api/attachments/${attachment.id}/download" class="btn btn-outline btn-sm" style="padding: 4px 8px; font-size: 12px;">
                                    ⬇️ Télécharger
                                </a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) return 'à l\'instant';
            if (diffMins < 60) return `il y a ${diffMins}min`;
            if (diffHours < 24) return `il y a ${diffHours}h`;
            if (diffDays < 7) return `il y a ${diffDays}j`;
            return formatDateTime(dateString);
        }
        
        // Gestion des dropdowns
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            const toggle = dropdown.querySelector('.dropdown-toggle');
            
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                dropdown.classList.toggle('active');
            });
            
            // Fermer si on clique ailleurs
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        });

        // File attachment functionality
        let selectedFiles = [];
        const attachFileBtn = document.getElementById('attachFileBtn');
        const fileInput = document.getElementById('fileInput');
        const attachmentSection = document.getElementById('attachmentSection');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        const commentForm = document.getElementById('commentForm');

        attachFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                // Check file size (10MB max)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`Le fichier "${file.name}" est trop volumineux (max 10MB)`);
                    return;
                }
                
                // Check if file is already selected
                const existingFile = selectedFiles.find(f => f.name === file.name && f.size === file.size);
                if (existingFile) {
                    alert(`Le fichier "${file.name}" est déjà sélectionné`);
                    return;
                }
                
                selectedFiles.push(file);
            });
            
            updateFileDisplay();
            fileInput.value = ''; // Clear input for next selection
        });

        function updateFileDisplay() {
            if (selectedFiles.length === 0) {
                attachmentSection.style.display = 'none';
                return;
            }

            attachmentSection.style.display = 'block';
            selectedFilesDiv.innerHTML = selectedFiles.map((file, index) => `
                <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm);">
                    <div style="font-size: 16px;">${getFileIcon(file.type)}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${file.name}</div>
                        <div style="font-size: 12px; color: var(--color-muted);">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" onclick="removeFile(${index})" style="background: none; border: none; color: var(--color-error); cursor: pointer; padding: 4px;">✕</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileDisplay();
        }

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return '🖼️';
            if (mimeType === 'application/pdf') return '📄';
            if (mimeType.includes('word') || mimeType.includes('document')) return '📝';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return '📊';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return '🗜️';
            return '📁';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                background: ${type === 'success' ? 'var(--color-success)' : 'var(--color-error)'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Handle form submission
        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = document.getElementById('commentContent').value.trim();
            if (!content) {
                alert('Le commentaire ne peut pas être vide');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Envoi en cours...';

                // Get ticket ID from URL or another source
                const ticketId = 1; // This should be dynamically set based on the actual ticket

                // First, create the comment
                const commentResponse = await api.createComment(ticketId, { content });
                
                if (!commentResponse.success) {
                    throw new Error(commentResponse.message || 'Erreur lors de la création du commentaire');
                }

                const commentId = commentResponse.data.comment.id;

                // Upload attachments if any
                if (selectedFiles.length > 0) {
                    submitBtn.textContent = `Upload ${selectedFiles.length} fichier(s)...`;
                    
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        try {
                            await api.uploadAttachment(commentId, file);
                        } catch (uploadError) {
                            console.error(`Erreur upload fichier ${file.name}:`, uploadError);
                            alert(`Erreur lors de l'upload du fichier "${file.name}": ${uploadError.message}`);
                        }
                    }
                }

                // Success - refresh comments and clear form
                document.getElementById('commentContent').value = '';
                selectedFiles = [];
                updateFileDisplay();
                
                // Reload comments
                await loadTicketComments();
                
                // Show success notification
                showNotification('Commentaire ajouté avec succès!', 'success');
                
            } catch (error) {
                console.error('Error submitting comment:', error);
                alert(`Erreur: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    </script>
</body>
</html>