<!DOCTYPE html>
<html lang="fr" class="theme-shape">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket #TCK-2024-001 - Shape SAV</title>
    <!-- Theme Shape Design System -->
    <link rel="stylesheet" href="/styles/theme-shape.css">
    <link rel="stylesheet" href="/src/components/ui/index.css">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/sidebar.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <link rel="stylesheet" href="/assets/css/client.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar__header">
                <div class="sidebar__logo">S</div>
                <div class="sidebar__logo-text">Shape SAV</div>
            </div>

            <nav class="sidebar__nav">
                <div class="sidebar__nav-section">
                    <a href="/client/tickets.html" class="sidebar__nav-item sidebar__nav-item--active">
                        <span class="sidebar__nav-text">Mes Tickets</span>
                        <span class="sidebar__nav-badge" id="ticketCount">0</span>
                    </a>
                    <a href="/client/invoices.html" class="sidebar__nav-item">
                        <span class="sidebar__nav-text">Mes Factures</span>
                    </a>
                    <a href="/client/profile.html" class="sidebar__nav-item">
                        <span class="sidebar__nav-text">Mon Profil</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar__footer">
                <div class="sidebar__user" id="sidebarUser">
                    <div class="sidebar__user-avatar" id="sidebarUserAvatar">--</div>
                    <div class="sidebar__user-info">
                        <div class="sidebar__user-name" id="sidebarUserName">Chargement...</div>
                        <div class="sidebar__user-role">Client</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <header class="main-header" style="padding: var(--space-2) var(--space-3); margin-bottom: var(--space-2);">
                <div class="main-header__left">
                    <div style="padding-left: var(--space-2);">
                        <h1 class="main-title" style="margin-bottom: var(--space-1);">Ticket #TCK-2024-001</h1>
                        <p class="main-subtitle" style="margin: 0;">Problème de connexion sur l'espace admin</p>
                    </div>
                </div>
                <div class="main-header__right">
                    <button class="btn btn--ghost btn--sm">← Retour</button>
                    <button class="btn btn--ghost btn--sm">Actions ▼</button>
                    <button id="logoutBtn" class="btn btn--ghost btn--sm">Déconnexion</button>
                </div>
            </header>
            
            <main class="page-content">
                
                <!-- Informations principales du ticket -->
                <div class="card" style="margin-bottom: var(--space-6);">
                    <div class="card-header">
                        <div>
                            <h2 style="font-family: var(--font-heading); font-size: 24px; margin: 0; color: var(--color-primary);">
                                Problème de connexion sur l'espace admin
                            </h2>
                            <div style="display: flex; gap: var(--space-3); align-items: center; margin-top: var(--space-2);">
                                <span class="badge status-en-cours">En cours</span>
                                <span class="badge" style="background: var(--color-error); color: var(--color-surface);">Urgent</span>
                                <span style="color: var(--color-muted); font-size: 14px;">
                                    Project: Site Web E-commerce
                                </span>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning" style="margin: 0; max-width: 300px;">
                            <div style="font-weight: 600;">SLA dans 4h</div>
                            <div style="font-size: 12px; margin-top: 4px;">
                                Temps de réponse contractuel bientôt dépassé
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Métadonnées du ticket -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-5); margin-bottom: var(--space-5); padding: var(--space-4); background: var(--color-bg); border-radius: var(--radius-md);">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em;">Créé le</div>
                                <div style="font-size: 16px; color: var(--color-text); margin-top: 4px;">15 janvier 2024, 14:30</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em;">Dernière mise à jour</div>
                                <div style="font-size: 16px; color: var(--color-text); margin-top: 4px;">Il y a 2 heures</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em;">Assigné à</div>
                                <div style="font-size: 16px; color: var(--color-text); margin-top: 4px;">Thomas Martin</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--color-muted); text-transform: uppercase; letter-spacing: 0.05em;">Temps de résolution</div>
                                <div style="font-size: 16px; color: var(--color-text); margin-top: 4px;">6h restantes</div>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div style="margin-bottom: var(--space-5);">
                            <h4 style="font-family: var(--font-heading); font-size: 18px; color: var(--color-primary); margin-bottom: var(--space-3);">
                                Description du problème
                            </h4>
                            <div style="background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-4); line-height: 1.6;">
                                <p>Bonjour,</p>
                                <p>Depuis hier soir (14 janvier vers 23h), il m'est impossible de me connecter à l'interface d'administration de notre site e-commerce.</p>
                                <p>Quand je saisis mes identifiants habituels, j'obtiens systématiquement le message d'erreur : <code style="background: var(--color-bg); padding: 2px 4px; border-radius: 3px; font-family: monospace;">"Identifiants incorrects"</code></p>
                                <p><strong>Informations techniques :</strong></p>
                                <ul>
                                    <li>URL concernée : <a href="https://admin.monsite.com" style="color: var(--color-primary);">https://admin.monsite.com</a></li>
                                    <li>Navigateur testé : Chrome 120.0.6099.109 et Firefox 121.0</li>
                                    <li>J'ai essayé de vider le cache et les cookies</li>
                                    <li>Le problème persiste en navigation privée</li>
                                </ul>
                                <p>Ce problème bloque complètement la gestion de notre boutique en ligne. Nous avons besoin d'une résolution rapide.</p>
                                <p>Merci de votre aide,<br>Marie Dubois</p>
                            </div>
                        </div>
                        
                        <!-- Pièces jointes -->
                        <div style="margin-bottom: var(--space-5);">
                            <h4 style="font-family: var(--font-heading); font-size: 18px; color: var(--color-primary); margin-bottom: var(--space-3);">
                                Pièces jointes (2)
                            </h4>
                            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                                <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                    <div style="font-size: 24px;">Image</div>
                                    <div style="flex: 1;">
                                        <a href="#" style="color: var(--color-primary); font-weight: 500; text-decoration: none;">screenshot-erreur-connexion.png</a>
                                        <div style="font-size: 14px; color: var(--color-muted);">Image • 342 Ko</div>
                                    </div>
                                    <button class="btn btn-outline" style="padding: 6px 12px;">
                                        Télécharger
                                    </button>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: var(--space-3); padding: var(--space-3); background: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                                    <div style="font-size: 24px;">File</div>
                                    <div style="flex: 1;">
                                        <a href="#" style="color: var(--color-primary); font-weight: 500; text-decoration: none;">logs-navigateur.txt</a>
                                        <div style="font-size: 14px; color: var(--color-muted);">Texte • 12 Ko</div>
                                    </div>
                                    <button class="btn btn-outline" style="padding: 6px 12px;">
                                        Télécharger
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Historique des échanges -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Historique des échanges (3)</h3>
                        <div style="font-size: 14px; color: var(--color-muted);">
                            Dernière réponse il y a 2 heures
                        </div>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div style="display: flex; flex-direction: column;">
                            
                            <!-- Message 1 - Création du ticket -->
                            <div style="padding: var(--space-5); border-bottom: 1px solid var(--color-border);">
                                <div style="display: flex; gap: var(--space-3);">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <span style="color: var(--color-surface); font-weight: 600; font-size: 14px;">MD</span>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                                            <div>
                                                <div style="font-weight: 600; color: var(--color-primary);">Marie Dubois</div>
                                                <div style="font-size: 14px; color: var(--color-muted);">Client</div>
                                            </div>
                                            <div style="font-size: 14px; color: var(--color-muted);">
                                                15 jan. 2024, 14:30
                                            </div>
                                        </div>
                                        <div style="background: var(--color-bg); padding: var(--space-3); border-radius: var(--radius-md); border-left: 3px solid var(--color-primary);">
                                            <strong>Ticket créé</strong><br>
                                            Problème de connexion sur l'espace admin - [Voir description complète ci-dessus]
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Message 2 - Réponse du support -->
                            <div style="padding: var(--space-5); border-bottom: 1px solid var(--color-border);">
                                <div style="display: flex; gap: var(--space-3);">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-accent); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <span style="color: var(--color-primary); font-weight: 600; font-size: 14px;">TM</span>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                                            <div>
                                                <div style="font-weight: 600; color: var(--color-primary);">Thomas Martin</div>
                                                <div style="font-size: 14px; color: var(--color-muted);">Support technique</div>
                                            </div>
                                            <div style="font-size: 14px; color: var(--color-muted);">
                                                15 jan. 2024, 15:45
                                            </div>
                                        </div>
                                        <div style="background: var(--color-surface); padding: var(--space-3); border-radius: var(--radius-md); border: 1px solid var(--color-border);">
                                            <p>Bonjour Marie,</p>
                                            <p>Merci pour votre signalement. J'ai pris en charge votre ticket et je vais investiguer immédiatement.</p>
                                            <p>J'ai identifié un problème avec notre serveur d'authentification qui affecte certains comptes admin. Nous travaillons actuellement sur une correction.</p>
                                            <p><strong>Solution temporaire :</strong> Puis-je vous demander d'essayer de vous connecter avec ce lien de récupération : <a href="#" style="color: var(--color-primary);">admin.monsite.com/recovery</a></p>
                                            <p>Je vous tiens informée de l'avancement.</p>
                                            <p>Cordialement,<br>Thomas Martin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Message 3 - Réponse du client -->
                            <div style="padding: var(--space-5);">
                                <div style="display: flex; gap: var(--space-3);">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-primary); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <span style="color: var(--color-surface); font-weight: 600; font-size: 14px;">MD</span>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                                            <div>
                                                <div style="font-weight: 600; color: var(--color-primary);">Marie Dubois</div>
                                                <div style="font-size: 14px; color: var(--color-muted);">Client</div>
                                            </div>
                                            <div style="font-size: 14px; color: var(--color-muted);">
                                                Aujourd'hui, 09:15
                                            </div>
                                        </div>
                                        <div style="background: var(--color-bg); padding: var(--space-3); border-radius: var(--radius-md); border-left: 3px solid var(--color-primary);">
                                            <p>Bonjour Thomas,</p>
                                            <p>Merci pour votre réponse rapide !</p>
                                            <p>J'ai essayé le lien de récupération que vous m'avez envoyé, mais j'obtiens toujours la même erreur. Pouvez-vous vérifier si mon compte n'est pas bloqué ?</p>
                                            <p>En attendant, cela nous bloque pour traiter les commandes du jour.</p>
                                            <p>Merci,<br>Marie</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zone de réponse -->
                    <div class="card-footer" style="background: var(--color-bg);">
                        <div style="margin-bottom: var(--space-3);">
                            <h4 style="font-family: var(--font-heading); font-size: 16px; color: var(--color-primary); margin-bottom: var(--space-2);">
                                Ajouter une réponse
                            </h4>
                            <div class="alert alert-info" style="margin-bottom: var(--space-3);">
                                <strong> Conseil :</strong> Soyez précis dans votre description et n'hésitez pas à joindre des captures d'écran pour nous aider à mieux comprendre le problème.
                            </div>
                        </div>
                        
                        <form id="commentForm" style="display: flex; flex-direction: column; gap: var(--space-3);">
                            <div class="form-group">
                                <textarea 
                                    id="commentContent"
                                    class="form-textarea" 
                                    placeholder="Décrivez votre problème ou votre question..."
                                    rows="4"
                                    style="resize: vertical;"
                                    required
                                ></textarea>
                            </div>
                            
                            <!-- File attachments section -->
                            <div id="attachmentSection" style="border: 1px dashed var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); display: none;">
                                <h5 style="margin: 0 0 var(--space-2) 0; color: var(--color-primary);">Pièces jointes sélectionnées</h5>
                                <div id="selectedFiles" style="display: flex; flex-direction: column; gap: var(--space-2);"></div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; gap: var(--space-2); align-items: center;">
                                    <button type="button" id="attachFileBtn" class="btn btn-outline">
                                         Joindre un fichier
                                    </button>
                                    <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.gif,.bmp,.webp,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip,.rar" style="display: none;">
                                    <span style="font-size: 12px; color: var(--color-muted);">
                                        Max 10MB par fichier
                                    </span>
                                </div>
                                
                                <div style="display: flex; gap: var(--space-2);">
                                    <button type="button" class="btn btn-outline">
                                         Brouillon
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                         Envoyer la réponse
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Overlay mobile -->
    
    <script src="/assets/js/api.js?v=1756818386"></script>
    <script>

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('token');
            window.location.href = '/connexion.html';
        });

        // Load user info
        function loadUserInfo() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/connexion.html';
                return;
            }
            
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                document.getElementById('sidebarUserName').textContent = payload.email || 'Utilisateur';
                document.getElementById('sidebarUserAvatar').textContent = (payload.email || 'U').charAt(0).toUpperCase();
            } catch (e) {
                console.error('Token invalide', e);
                window.location.href = '/connexion.html';
            }
        }

        loadUserInfo();
        
        // Gestion des dropdowns
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            const toggle = dropdown.querySelector('.dropdown-toggle');
            
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                dropdown.classList.toggle('active');
            });
            
            // Fermer si on clique ailleurs
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        });

        // File attachment functionality
        let selectedFiles = [];
        const attachFileBtn = document.getElementById('attachFileBtn');
        const fileInput = document.getElementById('fileInput');
        const attachmentSection = document.getElementById('attachmentSection');
        const selectedFilesDiv = document.getElementById('selectedFiles');
        const commentForm = document.getElementById('commentForm');

        attachFileBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                // Check file size (10MB max)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`Le fichier "${file.name}" est trop volumineux (max 10MB)`);
                    return;
                }
                
                // Check if file is already selected
                const existingFile = selectedFiles.find(f => f.name === file.name && f.size === file.size);
                if (existingFile) {
                    alert(`Le fichier "${file.name}" est déjà sélectionné`);
                    return;
                }
                
                selectedFiles.push(file);
            });
            
            updateFileDisplay();
            fileInput.value = ''; // Clear input for next selection
        });

        function updateFileDisplay() {
            if (selectedFiles.length === 0) {
                attachmentSection.style.display = 'none';
                return;
            }

            attachmentSection.style.display = 'block';
            selectedFilesDiv.innerHTML = selectedFiles.map((file, index) => `
                <div style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-2); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-sm);">
                    <div style="font-size: 16px;">${getFileIcon(file.type)}</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${file.name}</div>
                        <div style="font-size: 12px; color: var(--color-muted);">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" onclick="removeFile(${index})" style="background: none; border: none; color: var(--color-error); cursor: pointer; padding: 4px;">✕</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileDisplay();
        }

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return '🖼️';
            if (mimeType === 'application/pdf') return '📄';
            if (mimeType.includes('word') || mimeType.includes('document')) return '📝';
            if (mimeType.includes('sheet') || mimeType.includes('excel')) return '📊';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return '🗜️';
            return '📁';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Handle form submission
        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const content = document.getElementById('commentContent').value.trim();
            if (!content) {
                alert('Le commentaire ne peut pas être vide');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Envoi en cours...';

                // Get ticket ID from URL or another source
                const ticketId = 1; // This should be dynamically set based on the actual ticket

                // First, create the comment
                const commentResponse = await api.createComment(ticketId, { content });
                
                if (!commentResponse.success) {
                    throw new Error(commentResponse.message || 'Erreur lors de la création du commentaire');
                }

                const commentId = commentResponse.data.comment.id;

                // Upload attachments if any
                if (selectedFiles.length > 0) {
                    submitBtn.textContent = `Upload ${selectedFiles.length} fichier(s)...`;
                    
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        try {
                            await api.uploadAttachment(commentId, file);
                        } catch (uploadError) {
                            console.error(`Erreur upload fichier ${file.name}:`, uploadError);
                            alert(`Erreur lors de l'upload du fichier "${file.name}": ${uploadError.message}`);
                        }
                    }
                }

                // Success - refresh page or update UI
                alert('Commentaire ajouté avec succès!');
                location.reload();
                
            } catch (error) {
                console.error('Error submitting comment:', error);
                alert(`Erreur: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    </script>
</body>
</html>